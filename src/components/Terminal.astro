---
// Terminal intro - fixed height, exactly 7 lines
import { useI18n } from "@ariaskit/astro-i18n";
import { type LocaleSchema } from "@/src/types";

const locales = ["de", "en", "es"] as const;

const translations = locales.map((locale) => {
  const { t } = useI18n<LocaleSchema>({
    ssg: {
      // @ts-ignore
      locale,
    },
  });
  
  return {
    locale,
    sequence: [
      { prompt: true, text: t("terminal.skills_cmd") },
      { prompt: false, text: t("terminal.skills") },
      { prompt: true, text: t("terminal.hobbies_cmd") },
      { prompt: false, text: t("terminal.hobbies") },
      { prompt: true, text: t("terminal.focus_cmd") },
      { prompt: false, text: t("terminal.focus") },
      { prompt: true, hint: true, text: t("terminal.hint") },
    ],
  };
});
---

<div class="font-mono text-sm opacity-80 mb-8" data-lang-section>
  <div class="flex items-center gap-2 px-3 py-2 bg-secondary/50 rounded-t-lg border border-border border-b-0">
    <span class="w-3 h-3 rounded-full bg-red-500/70"></span>
    <span class="w-3 h-3 rounded-full bg-yellow-500/70"></span>
    <span class="w-3 h-3 rounded-full bg-green-500/70"></span>
    <span class="ml-2 text-xs opacity-50">terminal — zsh</span>
  </div>
  <div class="bg-secondary/30 border border-border rounded-b-lg h-[190px]">
    <div id="terminal-output" class="p-3 leading-6 h-full" data-lang-content>
      {translations.map((trans) => (
        <div class="lang-content hidden" data-lang={trans.locale}>
          <!-- Content rendered by JS -->
        </div>
      ))}
    </div>
  </div>
</div>

<style is:global>
  @keyframes terminalCursorBlink {
    0%, 62% { opacity: 1; }
    63%, 100% { opacity: 0.18; }
  }

  .terminal-cursor {
    display: inline-block;
    width: 0.08em;
    min-width: 1px;
    height: 1.08em;
    margin-left: 0.08rem;
    border-radius: 0;
    background: var(--foreground);
    vertical-align: -0.14em;
    animation: terminalCursorBlink 1s steps(1, end) infinite;
  }

  @media (prefers-reduced-motion: reduce) {
    .terminal-cursor {
      animation: terminalCursorBlink 1.2s steps(1, end) infinite;
    }
  }
</style>

<script>
  const terminalOutput = document.getElementById('terminal-output') as HTMLElement;
  const TERMINAL_ANIMATED_KEY = 'terminal-animated';
  
  const sequences: Record<string, Array<{prompt: boolean; text: string; hint?: boolean}>> = {
    de: [
      { prompt: true, text: 'cat skills.txt' },
      { prompt: false, text: 'Go • Kubernetes • GitOps • Cloud-Native' },
      { prompt: true, text: 'cat hobbies.txt' },
      { prompt: false, text: 'Homelab • Open Source • Automatisierung' },
      { prompt: true, text: 'echo $CURRENT_FOCUS' },
      { prompt: false, text: 'bootc • Immutable Infrastructure • eBPF' },
      { prompt: true, hint: true, text: 'Drücke ? für Menü' },
    ],
    en: [
      { prompt: true, text: 'cat skills.txt' },
      { prompt: false, text: 'Go • Kubernetes • GitOps • Cloud-Native' },
      { prompt: true, text: 'cat hobbies.txt' },
      { prompt: false, text: 'Homelab • Open Source • Automation' },
      { prompt: true, text: 'echo $CURRENT_FOCUS' },
      { prompt: false, text: 'bootc • Immutable Infrastructure • eBPF' },
      { prompt: true, hint: true, text: 'Press ? for menu' },
    ],
    es: [
      { prompt: true, text: 'cat skills.txt' },
      { prompt: false, text: 'Go • Kubernetes • GitOps • Cloud-Native' },
      { prompt: true, text: 'cat hobbies.txt' },
      { prompt: false, text: 'Homelab • Código Abierto • Automatización' },
      { prompt: true, text: 'echo $CURRENT_FOCUS' },
      { prompt: false, text: 'bootc • Infraestructura Inmutable • eBPF' },
      { prompt: true, hint: true, text: 'Pulsa ? para menú' },
    ],
  };

  function sleep(ms: number) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  function createCursor() {
    const cursor = document.createElement('span');
    cursor.className = 'terminal-cursor';
    cursor.setAttribute('aria-hidden', 'true');
    return cursor;
  }

  function renderFinalState(sequence: typeof sequences.de) {
    terminalOutput.innerHTML = '';
    
    for (const item of sequence) {
      const line = document.createElement('div');
      line.className = 'flex items-center min-w-0';

      const textSpan = document.createElement('span');
      textSpan.textContent = item.text;

      if (item.prompt) {
        const prompt = document.createElement('span');
        prompt.className = 'text-green-500 mr-1.5';
        prompt.textContent = '❯';
        if (item.hint) {
          textSpan.className = 'text-xs opacity-55 truncate';
        }
        line.appendChild(prompt);
        line.appendChild(textSpan);
      } else {
        textSpan.className = item.hint ? 'text-xs opacity-50 truncate' : 'opacity-70';
        line.appendChild(textSpan);
      }

      terminalOutput.appendChild(line);
    }

    // Add blinking cursor to last line
    const cursor = createCursor();
    terminalOutput.lastElementChild?.appendChild(cursor);
  }

  async function runTerminal(sequence: typeof sequences.de) {
    terminalOutput.innerHTML = '';
    
    for (const item of sequence) {
      const line = document.createElement('div');
      line.className = 'flex items-center min-w-0';

      const textSpan = document.createElement('span');
      const cursor = createCursor();

      if (item.prompt) {
        const prompt = document.createElement('span');
        prompt.className = 'text-green-500 mr-1.5';
        prompt.textContent = '❯';
        if (item.hint) {
          textSpan.className = 'text-xs opacity-55 truncate';
        }
        line.appendChild(prompt);
        line.appendChild(textSpan);
        line.appendChild(cursor);
      } else {
        textSpan.className = item.hint ? 'text-xs opacity-50 truncate' : 'opacity-70';
        line.appendChild(textSpan);
        line.appendChild(cursor);
      }

      // Remove cursor from previous line
      const lastLine = terminalOutput.lastElementChild;
      const prevCursor = lastLine?.querySelector('.terminal-cursor');
      if (prevCursor) prevCursor.remove();

      terminalOutput.appendChild(line);

      // Type the text
      for (let j = 0; j < item.text.length; j++) {
        textSpan.textContent += item.text[j];
        await sleep(18 + Math.random() * 12);
      }

      await sleep(120);
    }

    sessionStorage.setItem(TERMINAL_ANIMATED_KEY, 'true');
  }

  function getCurrentLocale(): string {
    return document.documentElement.lang || 'de';
  }

  function initTerminal() {
    const locale = getCurrentLocale();
    const sequence = sequences[locale] || sequences.de;
    
    // Check if animation already ran this session
    if (sessionStorage.getItem(TERMINAL_ANIMATED_KEY)) {
      renderFinalState(sequence);
    } else {
      runTerminal(sequence);
    }
  }

  // Initialize
  initTerminal();

  // Just update content on language change (no re-animation)
  window.addEventListener('languagechange', (e: Event) => {
    const customEvent = e as CustomEvent<{ locale: string }>;
    const locale = customEvent.detail.locale;
    const sequence = sequences[locale] || sequences.de;
    
    // Show final state for new language (already animated)
    renderFinalState(sequence);
  });
</script>
