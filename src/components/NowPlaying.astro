---
// Spotify Now Playing widget
// Connects to /api/spotify server endpoint
---

<div id="now-playing" class="border border-border rounded-lg p-3 h-fit w-full min-w-0">
  <div class="flex items-center gap-2.5">
    <div id="spotify-icon" class="w-8 h-8 rounded bg-[#1DB954]/20 flex items-center justify-center shrink-0">
      <svg class="w-4 h-4 text-[#1DB954]" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
      </svg>
    </div>
    <div class="flex-1 min-w-0">
      <div id="track-status" class="text-xs opacity-50 mb-0.5">Not playing</div>
      <div id="track-name-viewport" class="track-name-viewport">
        <div id="track-name" class="track-name">—</div>
      </div>
      <div id="track-artist" class="text-xs opacity-70 truncate">—</div>
    </div>
    <div id="playing-indicator" class="hidden flex items-end gap-0.5 h-4">
      <span class="w-1 bg-[#1DB954] rounded-full animate-bounce" style="height: 8px; animation-delay: 0ms;"></span>
      <span class="w-1 bg-[#1DB954] rounded-full animate-bounce" style="height: 12px; animation-delay: 150ms;"></span>
      <span class="w-1 bg-[#1DB954] rounded-full animate-bounce" style="height: 6px; animation-delay: 300ms;"></span>
    </div>
  </div>
</div>

<script>
  function updateTrackNameAnimation() {
    const viewport = document.getElementById('track-name-viewport');
    const trackName = document.getElementById('track-name');
    if (!viewport || !trackName) return;

    trackName.classList.remove('track-name-scroll');
    trackName.style.removeProperty('--scroll-distance');
    trackName.style.removeProperty('--scroll-duration');
    trackName.style.transform = 'translateX(0)';

    const overflow = trackName.scrollWidth - viewport.clientWidth;
    if (overflow <= 4) return;

    const distance = overflow + 16;
    const duration = Math.min(18, Math.max(7, distance / 22));
    trackName.style.setProperty('--scroll-distance', `${distance}px`);
    trackName.style.setProperty('--scroll-duration', `${duration}s`);
    trackName.classList.add('track-name-scroll');
  }

  function setNowPlayingState(status: string, title: string, artist: string, isPlaying: boolean) {
    const trackStatus = document.getElementById('track-status');
    const trackName = document.getElementById('track-name');
    const trackArtist = document.getElementById('track-artist');
    const playingIndicator = document.getElementById('playing-indicator');

    if (!trackStatus || !trackName || !trackArtist || !playingIndicator) return;

    trackStatus.textContent = status;
    trackName.textContent = title;
    trackArtist.textContent = artist;
    playingIndicator.classList.toggle('hidden', !isPlaying);
    requestAnimationFrame(updateTrackNameAnimation);
  }

  async function fetchNowPlaying() {
    try {
      const response = await fetch('/api/spotify', {
        cache: 'no-store',
      });

      if (!response.ok) {
        throw new Error(`Spotify endpoint returned ${response.status}`);
      }

      const data = await response.json();

      if (data.source === 'unconfigured') {
        setNowPlayingState('Spotify not configured', '—', 'Set SPOTIFY_* server env vars', false);
        return;
      }

      if (data.isPlaying && (data.title || data.artist)) {
        setNowPlayingState('Now playing', data.title || '—', data.artist || '—', true);
        return;
      }

      if (data.title || data.artist) {
        setNowPlayingState('Last played', data.title || '—', data.artist || '—', false);
        return;
      }

      setNowPlayingState('Not playing', '—', '—', false);
    } catch {
      setNowPlayingState('Spotify unavailable', '—', 'Check server logs', false);
    }
  }

  fetchNowPlaying();
  setInterval(fetchNowPlaying, 30000);
  window.addEventListener('resize', updateTrackNameAnimation);
</script>

<style>
  .track-name-viewport {
    position: relative;
    width: 100%;
    min-width: 0;
    overflow: hidden;
  }

  .track-name-viewport::before,
  .track-name-viewport::after {
    content: "";
    position: absolute;
    top: 0;
    bottom: 0;
    width: 14px;
    pointer-events: none;
    z-index: 1;
  }

  .track-name-viewport::before {
    left: 0;
    background: linear-gradient(to right, var(--background), transparent);
  }

  .track-name-viewport::after {
    right: 0;
    background: linear-gradient(to left, var(--background), transparent);
  }

  .track-name {
    font-size: 0.875rem;
    line-height: 1.25rem;
    font-weight: 500;
    white-space: nowrap;
    transform: translateX(0);
    will-change: transform;
    position: relative;
    z-index: 0;
  }

  .track-name-scroll {
    animation: track-name-marquee var(--scroll-duration, 9s) ease-in-out infinite alternate;
  }

  @keyframes track-name-marquee {
    from {
      transform: translateX(0);
    }
    to {
      transform: translateX(calc(var(--scroll-distance, 0px) * -1));
    }
  }
</style>
